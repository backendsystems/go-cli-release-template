name: Test Install via go install

on:
  workflow_dispatch:

jobs:
  go-install:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu
            arch: x64
            runs_on: ubuntu-24.04
          - os: ubuntu
            arch: arm64
            runs_on: ubuntu-24.04-arm
          - os: windows
            arch: x64
            runs_on: windows-2022
          - os: windows
            arch: arm64
            runs_on: windows-11-arm
          - os: macos
            arch: x64
            runs_on: macos-15-intel
          - os: macos
            arch: arm64
            runs_on: macos-15
    runs-on: ${{ matrix.runs_on }}
    steps:
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.2'
          cache: false

      - name: Configure isolated GOBIN (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          GOBIN_DIR="${RUNNER_TEMP}/go-bin-${{ matrix.os }}-${{ matrix.arch }}"
          mkdir -p "$GOBIN_DIR"
          echo "GOBIN=$GOBIN_DIR" >> "$GITHUB_ENV"
          echo "$GOBIN_DIR" >> "$GITHUB_PATH"

      - name: Configure isolated GOBIN (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $gobin = Join-Path $env:RUNNER_TEMP "go-bin-${{ matrix.os }}-${{ matrix.arch }}"
          New-Item -ItemType Directory -Force -Path $gobin | Out-Null
          "GOBIN=$gobin" | Out-File -FilePath $env:GITHUB_ENV -Append
          $gobin | Out-File -FilePath $env:GITHUB_PATH -Append

      - name: Install YOUR_PROJECT with go install
        run: go install github.com/YOUR_OWNER/YOUR_PROJECT@latest

      - name: Smoke test YOUR_PROJECT startup
        uses: YOUR_OWNER/YOUR_PROJECT/.github/actions/smoke-test@main
